%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2d5a87', 'lineColor': '#5c6bc0', 'secondaryColor': '#81c784', 'tertiaryColor': '#fff3e0'}}}%%
flowchart TD
    start([Execute Request])

    subgraph context["AutomationContext"]
        resolve[Resolve target to hosts]
        aggregate[Aggregate results]
        audit[Filter secrets & audit log]
    end

    subgraph executor["ModuleExecutor"]
        chunk[Chunk hosts into groups of N]

        subgraph parallel["Parallel Goroutines"]
            g1[Host 1]
            g2[Host 2]
            g3[Host N]
        end

        collect[Collect chunk results]
        next{More chunks?}
    end

    subgraph runners["Runner Selection"]
        islocal{Local host?}

        subgraph local["LocalRunner"]
            ftlcheck{FTL module?}
            ftlexec[Execute Go function]
            ansible[Execute Ansible subprocess]
        end

        subgraph remote["RemoteRunner"]
            connect[SSH Connect]
            deploy[Deploy gate.pyz]
            send[Send Module message]
            receive[Receive Result]
        end
    end

    result([Return ExecutionResults])

    start --> resolve
    resolve --> chunk
    chunk --> g1 & g2 & g3
    g1 & g2 & g3 --> islocal

    islocal -->|Yes| ftlcheck
    islocal -->|No| connect

    ftlcheck -->|Yes| ftlexec
    ftlcheck -->|No| ansible

    connect --> deploy
    deploy --> send
    send --> receive

    ftlexec --> collect
    ansible --> collect
    receive --> collect

    collect --> next
    next -->|Yes| chunk
    next -->|No| aggregate

    aggregate --> audit
    audit --> result
